# CP02电源监控项目

## 项目概述
这是一个基于ESP32-C6开发的电源监控系统，主要用于实时监控和显示多个USB-C端口的供电状态。项目集成了WiFi配置、电源监控、RGB指示灯和LCD显示等功能模块。系统采用线程安全的界面管理机制，支持mDNS智能设备发现，具备高稳定性和自动故障恢复能力。

## 硬件组成
1. 主控制器：ESP32-C6（单核处理器）
2. 显示屏：ST7789驱动的LCD屏幕
3. RGB指示灯
4. USB-C端口：5个监控端口（A1, C1, C2, C3, C4）

## 软件架构

### 1. 配置管理模块（Config_Manager）
- 负责WiFi网络配置
- 提供Web配置界面
- 管理系统参数存储
- 特点：
  - 支持AP模式配置
  - 配置数据持久化存储
  - 支持配置重置功能
  - WiFi连接状态管理

### 2. 显示管理模块（Display_Manager）
- 管理不同显示界面的切换
- 包含多个主要界面：
  - AP配置界面
  - 电源监控界面
  - WiFi错误界面
  - 时间显示界面
  - 设备扫描界面
- 使用LVGL图形库实现UI
- 特点：
  - 互斥锁保护的线程安全界面切换
  - 状态一致性检查和自动修复
  - 紧急重置功能防止界面冲突

### 3. 电源监控模块（Power_Monitor）
- 实时监控各端口电源状态
- 功能特点：
  - 支持5个端口独立监控
  - 显示电压、电流、功率数据
  - 总功率计算和显示
  - 进度条显示功率使用情况
  - 异常状态提示

### 4. RGB指示灯模块（RGB_Lamp）
- 提供视觉反馈
- 可通过配置界面开启/关闭
- 支持动态效果

## 主要功能

### 1. WiFi配置功能
- 首次使用自动进入AP模式
- Web配置界面（http://设备IP）
- 智能设备发现：
  - mDNS自动发现cp02设备
  - 传统IP扫描备用方案
  - 自动配置服务器地址
- 支持：
  - WiFi网络设置
  - 监控服务器配置
  - RGB灯控制
  - 系统重置

### 2. 电源监控功能
- 实时监控参数：
  - 各端口电压
  - 各端口电流
  - 各端口功率
  - 总功率
- 安全限制：
  - 单端口最大功率：140W
  - 总功率上限：160W
- 智能故障检测：
  - 区分临时网络问题和设备故障
  - 快速响应机制（10秒触发扫描）
  - 防误触发保护（连续失败阈值）

### 3. 显示功能
- 实时数据显示
- 进度条可视化
- WiFi状态指示
- 异常状态提示

## 工作流程

### 1. 系统启动
- 初始化显示
- 检查配置状态
- 启动必要服务

### 2. 正常工作模式
- 连接WiFi网络
- 获取电源数据
- 更新显示界面
- 控制RGB指示

### 3. 配置模式
- 启动AP热点
- 提供Web配置界面
- 保存新配置
- 重启进入工作模式

## 异常处理

### 1. WiFi断开处理
- 显示错误界面
- 自动重连
- 状态指示

### 2. 数据异常处理
- 显示错误提示
- 继续尝试获取数据
- 保持界面响应

## 优化特点

### 1. 单任务设计
- 适应ESP32-C6单核特性
- 优化资源利用
- 提高系统稳定性

### 2. 界面优化
- 紧凑布局设计
- 直观的数据展示
- 清晰的状态反馈

### 3. 稳定性保障
- 看门狗保护
- 异常自动恢复
- 配置持久化

## 注意事项

### 1. 配置相关
- 首次使用需要配置WiFi
- 记录配置参数
- 可随时重置配置

### 2. 使用限制
- 注意功率限制
- 确保WiFi信号稳定
- 定期检查连接状态

### 3. 维护建议
- 定期检查系统状态
- 保持固件更新
- 注意环境温度

## 开发环境
- 开发平台：Arduino IDE
- 主要依赖：
  - LVGL图形库
  - ESP32 Arduino核心库
  - WiFi库
  - WebServer库
  - DNSServer库
  - ESPmDNS库（设备发现）
  - HTTPClient库
  - Preferences库

## 许可证
本项目采用MIT许可证。详细信息请参见LICENSE文件。

## 贡献
欢迎提交问题报告和改进建议。如果您想为项目做出贡献，请遵循以下步骤：
1. Fork本仓库
2. 创建您的特性分支
3. 提交您的改动
4. 推送到您的分支
5. 创建Pull Request

## 更新日志
### V1.0.13 (2025-01-02)
#### 网络扫描响应速度极速优化
- 扫描触发时间大幅优化
  - 扫描重试间隔从10秒缩短至6秒，提升40%响应速度
  - 连续失败阈值从3次优化至2次，减少等待时间
  - 持久错误触发时间：从约13秒缩短至约7秒（46%提升）
  - 临时错误触发时间：从约16秒缩短至约8秒（50%提升）
  
- 系统超时参数全面优化
  - 数据获取超时从10秒缩短至8秒
  - WiFi错误界面显示从15秒提前至12秒
  - 保持智能错误识别机制，防止频繁误触发
  
- 用户体验显著提升
  - 真实网络故障情况下7-8秒内快速响应
  - 仍然有效防止网络抖动和短暂故障的误判
  - 系统整体响应更加敏捷，用户等待时间大幅减少

### V1.0.12 (2025-01-02)
#### 智能网络故障检测与快速扫描优化
- 网络扫描触发机制重大优化
  - 扫描触发时间从30秒缩短至10秒，显著提升故障响应速度
  - 实现智能失败检测机制：区分临时网络问题和真正的设备故障
  - 连续失败阈值机制：防止偶发网络问题误触发扫描
  - 差异化错误处理策略：临时错误需6次连续失败，持久错误需3次连续失败
  - 自动重置机制：成功连接时自动清零失败计数器
  
- 错误类型智能识别系统
  - 临时错误识别：HTTP超时(-1)、404、500、502、503、504等服务器临时问题
  - 持久错误识别：连接拒绝、网络不可达等真正的连接故障
  - 针对不同错误类型采用不同的触发阈值，避免误判
  - 详细的错误分类日志输出，便于问题诊断和监控
  
- 用户体验显著提升
  - 真正需要扫描时10秒内快速响应，而非等待30秒
  - 服务器临时维护或重启不会立即触发设备扫描
  - 网络抖动和短暂连接问题不会影响正常使用
  - 提供清晰的等待状态提示："Waiting before scan (2/6 failures, temporary error)"
  
- 系统稳定性增强
  - 智能容错机制：适应不同网络环境和服务器状况
  - 多点重置保障：WiFi重连、设备发现、连接恢复时均重置状态
  - 防抖动设计：避免网络波动导致的频繁界面切换
  - 增强日志系统：详细记录失败类型、计数和触发原因

### V1.0.11 (2025-01-02)
#### 系统稳定性和网络发现重大升级
- 屏幕切换互斥锁系统完善
  - 实现单一LVGL互斥锁保护所有屏幕操作，避免双锁死锁问题
  - 完善所有屏幕创建、删除、更新函数的锁保护机制
  - 新增状态一致性检查函数`isValidScreenState()`，检测多屏幕同时活跃异常
  - 实现紧急重置功能`resetAllScreenStates()`，异常状态自动修复
  - 添加互斥锁超时机制（5秒），防止无限等待导致系统卡死
  - 优化`hideAllContainers()`函数，同步隐藏UI和重置状态标志
  - 增加调试支持（DEBUG_DISPLAY_LOCKS），可选的详细锁操作日志
  
- mDNS智能设备发现系统
  - 网络扫描从传统IP扫描升级为mDNS优先发现机制
  - 专门查找cp02设备：直接解析`cp02.local`主机名
  - 实现双重发现策略：主机名解析 + HTTP服务发现
  - 智能服务匹配：浏览网络HTTP服务，查找包含"cp02"的设备
  - 保留IP扫描作为备用方案，确保向后兼容性
  - 显著提升扫描效率：mDNS查找比254个IP扫描快10倍以上
  - 网络友好设计：大幅减少网络流量和设备负载
  - 动态适应能力：即使设备IP地址改变，仍可通过主机名找到
  
- 用户界面优化升级
  - 扫描界面文案更新：明确显示"Looking for cp02..."
  - 状态信息精确化：显示"Using mDNS to find cp02 device"
  - 扫描进度实时反馈："Starting mDNS scan for cp02..."
  - 结果状态清晰提示："cp02 found! Connecting..." / "cp02 not found, will retry..."
  - 改进扫描状态管理，提供用户友好的反馈信息
  
- 代码质量和安全性提升
  - 修复mDNS API调用错误：使用正确的`address(i)`替代`IP(i)`
  - 完善错误处理机制，增强系统稳定性和故障恢复能力
  - 增加详细日志输出，便于问题诊断和系统监控
  - 优化超时设置，平衡扫描效率和可靠性
  - 代码注释完善，提高可维护性
  
- 技术架构改进
  - 实现互斥锁状态自动恢复：检测到未初始化时自动重建
  - 屏幕状态原子性操作：防止并发访问导致的状态不一致
  - 网络发现容错设计：多种发现方式确保设备连接稳定性
  - 性能优化：减少不必要的网络请求和UI操作

### V1.0.10 (2025-06-02)
#### PowerMonitor任务界面管理重构
- 界面跳转问题修复
  - 修复PowerMonitor_Task任务在运行过程中出现的界面跳转异常问题
  - 解决电源监控界面跳转到WiFi连接界面后无法正确跳转回来的bug
  - 重构界面状态管理系统，统一界面切换逻辑
  
- WiFi连接状态处理优化
  - 新增WiFi错误界面状态管理（UI_WIFI_ERROR）
  - 实现智能的WiFi断开检测：15秒超时后显示WiFi错误界面
  - 改进WiFi重连机制：连接恢复后立即切换回电源监控界面
  - 优化WiFi状态变化的响应速度和准确性
  
- 扫描网络功能改进
  - 在扫描过程中定期检查原连接是否恢复（每2秒检查一次）
  - 在扫描界面期间快速检查原连接状态（每3秒检查一次）
  - 优化扫描逻辑：仅在WiFi连接正常但数据获取失败时进行设备扫描
  - 避免在WiFi错误状态时进行不必要的设备扫描
  
- 界面状态管理重构
  - 实现统一的`safeUISwitch()`函数管理所有界面切换
  - 添加界面状态检查，避免重复创建或删除界面
  - 新增界面切换延迟机制，确保界面操作完成
  - 完善状态同步机制，防止界面状态冲突
  
- 用户体验提升
  - 优化界面切换的平滑性和稳定性
  - 增强异常状态的视觉反馈
  - 改进连接恢复时的响应速度
  - 提供清晰的状态指示和日志输出
  
- 代码质量改进
  - 重构PowerMonitor_Task主循环逻辑，提高代码可维护性
  - 增加详细的状态转换日志，便于问题诊断
  - 优化错误处理逻辑，增强系统稳定性
  - 完善超时机制和防抖处理

### V1.0.08 (2025-05-20)
#### 智能显示切换系统优化
- 低功耗模式优化
  - 新增自动时间显示功能：当功率低于1W持续30秒后，自动切换到时间显示界面
  - 在时间显示模式下自动关闭RGB指示灯，降低功耗
  - 当功率超过2W时，立即切换回电源监控界面并恢复RGB灯配置状态
  
- 显示切换机制改进
  - 优化界面切换逻辑，添加界面删除和延时机制，提高切换稳定性
  - 移除模式切换时间间隔限制，实现更快速的响应
  - 增加详细的调试输出，便于状态监控
  
- 代码结构优化
  - 重构显示管理逻辑，提高代码可维护性
  - 完善状态切换机制，增强系统稳定性
  - 优化中间状态处理，避免界面显示冲突

### V1.0.02 (2025-05-19)
#### UI系统稳定性更新
- 电源监控模块改进
  - 优化UI更新机制，提高显示稳定性
  - 改进电压区间判断逻辑，更精确的颜色显示
  - 增强数据错误状态处理
  - 添加UI组件空指针检查
  
- 内存管理优化
  - 使用静态缓冲区替代栈变量
  - 优化字符串处理逻辑
  - 增加缓冲区清理机制
  
- 显示安全性提升
  - 完善UI组件有效性验证
  - 改进错误状态显示逻辑
  - 优化电压颜色映射系统
  
- 代码质量改进
  - 增加详细的代码注释
  - 优化条件判断结构
  - 提高代码可维护性

### V1.0.00 (2025-05-18)
#### 初始版本发布
- 核心功能
  - 实现多端口USB-C电源监控系统
  - 支持5个独立监控端口（A1, C1, C2, C3, C4）
  - 实时显示电压、电流、功率数据
  - 总功率计算和显示功能
  
- 网络功能
  - WiFi配置管理系统
  - Web配置界面
  - AP模式自动配置
  - 设备自动发现功能
  
- 显示功能
  - 集成ST7789 LCD显示屏
  - LVGL图形库界面
  - 多界面切换系统
  - 实时数据可视化
  
- 指示系统
  - RGB指示灯控制
  - 状态可视化反馈
  - 可配置的灯光效果
  
- 安全特性
  - 单端口功率限制（140W）
  - 系统总功率保护（160W）
  - 异常状态监测和提示
  
- 系统优化
  - 单核处理器优化设计
  - 稳定性保障机制
  - 配置数据持久化
  - 自动故障恢复功能 